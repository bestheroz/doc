# Kafka 메시지 처리 시 장애 대응 방법


1.  프로듀서(Producer) 측 장애 대응

- 재시도 설정(Retry Configuration): 프로듀서가 메시지 전송에 실패했을 때 자동으로 재시도하도록 설정합니다. retries 설정을 통해 재시도 횟수를 지정할 수 있습니다.
- acks 설정: acks 설정을 통해 프로듀서가 메시지를 브로커에 얼마나 확실하게 전송할 것인지 결정합니다.
  - acks=all 또는 acks=-1: 모든 복제된 브로커가 메시지를 확인해야 전송이 완료된 것으로 간주.
  - 이는 메시지의 내구성을 높이지만 지연 시간이 증가할 수 있습니다.
- Idempotent Producer 사용: 중복 메시지 전송을 방지하기 위해 프로듀서의 멱등성(idempotence)을 활성화합니다. 이를 통해 네트워크 오류 등으로 인해 동일한 메시지가 여러 번 전송되는 것을 방지할 수 있습니다.

2. 컨슈머(Consumer) 측 장애 대응

- 컨슈머 그룹(Consumer Groups) 활용: 여러 컨슈머가 하나의 그룹을 형성하여 파티션을 분산 처리하도록 합니다. 컨슈머 그룹을 통해 장애 발생 시 다른 컨슈머가 해당 파티션을 인계받아 처리할 수 있습니다.
- 오프셋 관리(Offset Management):
  - 자동 커밋(Auto Commit): 컨슈머가 주기적으로 자동으로 오프셋을 커밋하도록 설정할 수 있습니다.
  - 수동 커밋(Manual Commit): 메시지를 성공적으로 처리한 후에만 오프셋을 커밋하도록 설정하여 메시지 손실을 방지합니다.
  - 오프셋 저장소: 오프셋을 외부 저장소(예: ZooKeeper, Kafka 내부 토픽)에 저장하여 장애 발생 시 복구할 수 있도록 합니다.
- 컨슈머 장애 복구: 컨슈머 인스턴스가 장애를 일으킬 경우, Kafka는 자동으로 해당 파티션을 다른 컨슈머에게 할당하여 메시지 처리를 지속할 수 있습니다.

3. 메시지 처리 전략

- 정확히 한 번(Exactly-Once) 처리 보장:
  - 트랜잭션 지원: Kafka는 트랜잭션을 지원하여 메시지의 중복 처리나 손실을 방지할 수 있습니다.
  - Idempotent Operations: 메시지를 여러 번 처리하더라도 결과가 동일하도록 멱등성 있는 연산을 구현합니다.
- Dead-Letter Queue(DLQ) 설정:
  - 처리에 반복적으로 실패하는 메시지를 별도의 토픽으로 이동시켜 문제 있는 메시지를 별도로 분석하고 처리할 수 있습니다.
  - DLQ를 통해 장애 원인을 분석하고, 필요한 경우 수동으로 메시지를 재처리할 수 있습니다.


